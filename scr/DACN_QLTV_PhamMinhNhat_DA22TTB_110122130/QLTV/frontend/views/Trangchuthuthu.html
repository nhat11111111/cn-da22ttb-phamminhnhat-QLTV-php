<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang ch·ªß th·ªß th∆∞ - Qu·∫£n l√Ω th∆∞ vi·ªán</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Small overrides local to page to keep file self-contained */
        .user-shell { padding: 0 }
        .book-cover { width:100%; height:140px; object-fit:cover; border-radius:6px; margin-bottom:8px; display:block }
        /* Th√™m style cho ph·∫ßn Th·ªÉ lo·∫°i v√† footer */
        section#categories-section h2 { font-size:32px; font-weight:800; color:#0f172a }
        .category-card h3 { font-size:20px; margin:0 0 8px 0; font-weight:700 }
        #categorySelect { font-size:16px }
        .site-footer { background:#083b7a; color:#fff; padding:28px 0; text-align:center; margin-top:40px }
        .site-footer .footer-inner { max-width:1200px; margin:0 auto; }
        .site-footer .footer-inner p { margin:6px 0 }
        
        /* Site Header */
        .site-header {
            background: #083b7a;
            color: #fff;
            padding: 12px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .site-header .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .site-header .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            white-space: nowrap;
        }
        .site-header .header-logo img {
            height: 40px;
            width: auto;
        }
        .site-header .header-search {
            flex: 1;
            max-width: 600px;
            position: relative;
        }
        .site-header .header-search input {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
        }
        .search-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 4px;
            display: none;
            z-index: 100;
        }
        .search-type-dropdown.show { display: block; }
        .search-type-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
            font-size: 14px;
        }
        .search-type-option:last-child { border-bottom: none; }
        .search-type-option:hover { background: #f3f4f6; }
        .search-type-option.active { background: #dbeafe; color: #1e40af; font-weight: 600; }
        .site-header .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .site-header .header-actions a {
            color: #fff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            white-space: nowrap;
        }
        .site-header .header-actions a:hover {
            opacity: 0.8;
        }
        
        /* Adjust body for fixed header */
        body { padding-top: 64px; }
        .admin-layout { margin-top: 0; }
    </style>
</head>
<body class="user-body">
    <!-- Site Header -->
    <header class="site-header">
        <div class="header-container">
            <div class="header-logo">
                <img src="../css/logo.png" alt="Logo" onerror="this.style.display='none'" />
                <span>TRUNG T√ÇM H·ªåC LI·ªÜU - TH∆Ø VI·ªÜN</span>
            </div>
            <div class="header-search">
                <input type="text" placeholder="Ch·ªçn lo·∫°i t√¨m ki·∫øm..." id="headerSearchInput" readonly />
                <div class="search-type-dropdown" id="searchTypeDropdown">
                    <div class="search-type-option" data-type="book">T√¨m t√™n s√°ch</div>
                    <div class="search-type-option" data-type="author">T√¨m t√°c gi·∫£</div>
                </div>
            </div>
            <div class="header-actions">
                <a href="#" id="headerNotificationBtn" title="Th√¥ng b√°o">
                    <span style="font-size:20px">üîî</span>
                    Th√¥ng b√°o
                </a>
                <a href="#" id="headerAccountBtn" title="T√†i kho·∫£n">
                    <span style="font-size:20px">üë§</span>
                    T√†i kho·∫£n
                </a>
            </div>
        </div>
    </header>

    <div class="admin-layout">
        <aside class="sidebar">
            <div class="brand">
                <img src="../css/logo.png" alt="logo" onerror="this.style.display='none'" />
                <div>
                    <h2>CELRI</h2>
                    <div style="font-size:12px;color:#6b7280">Qu·∫£n l√Ω th∆∞ vi·ªán</div>
                </div>
            </div>

            <nav class="menu">
                <div class="menu-section">
                    <div class="menu-item" data-action="home"><span class="icon">üè†</span> Trang ch·ªß</div>
                    <div class="menu-item" data-action="search"><span class="icon">üîç</span> T√¨m ki·∫øm</div>
                    <div class="menu-item" data-action="categories"><span class="icon">üìë</span> Th·ªÉ lo·∫°i</div>
                    <div class="menu-item" data-action="books"><span class="icon">üìö</span> Qu·∫£n l√Ω s√°ch</div>
                    <div class="menu-item" data-action="profile"><span class="icon">üë§</span> H·ªì s∆°</div>
                    <div class="menu-item" data-action="borrow-return"><span class="icon">üìñ</span> M∆∞·ª£n - Tr·∫£</div>
                    <div class="menu-item" data-action="stats"><span class="icon">üìà</span> Th·ªëng k√™</div>
                </div>

                <div style="border-top:1px solid #f1f5f9;padding-top:12px" class="menu-section">
                    <div class="menu-item" data-action="support"><span class="icon">üÜò</span> H·ªó tr·ª£</div>
                    <div class="menu-item" data-action="settings"><span class="icon">‚öôÔ∏è</span> C√†i ƒë·∫∑t</div>
                    <div class="menu-item" data-action="notifications"><span class="icon">üîî</span> Th√¥ng b√°o</div>
                    <div class="menu-item logout" id="sidebarLogout"><span class="icon">üö™</span> ƒêƒÉng xu·∫•t</div>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <section class="page-header">
                <div class="header-title">PH·∫¶N M·ªÄM QU·∫¢N L√ù TH∆Ø VI·ªÜN</div>
                <div class="header-meta">
                    <div id="clock" class="header-clock">--:--:--</div>
                </div>
            </section>

            <!-- Dashboard (m·∫∑c ƒë·ªãnh) -->
            <section id="dashboard-section">
                <div class="hero-banner">
                    <h1>CH√ÄO M·ª™NG QU·∫¢N TR·ªä VI√äN ƒê·∫æN</h1>
                    <p>H·ªá th·ªëng qu·∫£n l√Ω th∆∞ vi·ªán</p>
                </div>

                <section>
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>Ng√†y</th>
                                <th>Ca S√°ng</th>
                                <th>Ca Chi·ªÅu</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Th·ª© 2</td><td>Long</td><td>Ph√∫c</td></tr>
                            <tr><td>Th·ª© 3</td><td>Khoa</td><td>Ph√∫c</td></tr>
                            <tr><td>Th·ª© 4</td><td>Ph√∫c</td><td>Khoa</td></tr>
                            <tr><td>Th·ª© 5</td><td>Long</td><td>Khoa</td></tr>
                            <tr><td>Th·ª© 6</td><td>Khoa</td><td>Long</td></tr>
                            <tr><td>Th·ª© 7</td><td>Long</td><td>Ph√∫c</td></tr>
                            <tr><td>Ch·ªß nh·∫≠t</td><td>Ph√∫c</td><td>Long</td></tr>
                        </tbody>
                    </table>
                </section>
            </section>

            <!-- H·ªì s∆°: danh s√°ch ng∆∞·ªùi d√πng (t∆∞∆°ng t·ª± ·∫£nh) -->
            <section id="profile-section" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2>Danh s√°ch ng∆∞·ªùi d√πng (lo·∫°i: ƒê·ªôc gi·∫£)</h2>
                    <button class="primary-btn" id="refreshProfileBtn">L√†m m·ªõi</button>
                </div>
                <div class="card-surface" style="padding:18px">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                                <th>H·ªç t√™n</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th>Email</th>
                                <th>Lo·∫°i t√†i kho·∫£n</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="profileTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- T√¨m ki·∫øm -->
            <section id="search-section" style="display:none">
                <h2>Tra c·ª©u s√°ch</h2>
                <div id="bookGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:18px">
                    <!-- Nhi·ªÅu s√°ch m·∫´u (kh√¥ng c√≥ ·∫£nh, hi·ªÉn th·ªã ch·ªØ '·∫¢nh') -->
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">The Industries of the Future</div>
                        <div style="color:#6b7280;font-size:13px">(C√¥ng nghi·ªáp t∆∞∆°ng lai)</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">L·∫≠p tr√¨nh v√† Cu·ªôc s·ªëng</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Elon Musk: Tesla, SpaceX, and the Quest</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">The Pragmatic Programmer</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Code Complete 2</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">C√¥ng ngh·ªá 3S = 3S technology</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Sapiens: L∆∞·ª£c s·ª≠ lo√†i ng∆∞·ªùi</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Clean Code</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Design Patterns</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Introduction to Algorithms</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Deep Work</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Atomic Habits</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Thinking, Fast and Slow</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">The Lean Startup</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Hooked: How to Build Habit-Forming Products</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">The Art of Computer Programming</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9">
                        <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center">·∫¢nh</div>
                        <div style="font-weight:700">Refactoring: Improving the Design of Existing Code</div>
                    </div>
                </div>
            </section>

            <!-- S√°ch: b·∫£ng qu·∫£n l√Ω s√°ch -->
            <section id="books-section" style="display:none">
                <h2>Qu·∫£n l√Ω S√°ch</h2>
                <button class="primary-btn" id="addBookBtn" style="background:#ef4444;margin-bottom:12px">Th√™m s√°ch m·ªõi</button>
                <div style="background:#fff;border:1px solid #eef2f7;border-radius:10px;padding:18px">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>M√£ s√°ch</th>
                                <th>T√™n s√°ch</th>
                                <th>T√°c gi·∫£</th>
                                <th>NƒÉm xu·∫•t b·∫£n</th>
                                <th>Ng√¥n ng·ªØ</th>
                                <th>Th·ªÉ lo·∫°i</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Gi√° s√°ch</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="booksTableBody">
                            <!-- S√°ch s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Th·ªëng k√™: hi·ªÉn th·ªã cards v√† charts (placeholder) -->
            <section id="stats-section" style="display:none">
                <h2>Th·ªëng k√™ h·ªá th·ªëng</h2>
                <div style="display:flex;gap:18px;margin:12px 0 20px;flex-wrap:wrap">
                    <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);flex:1;min-width:180px;text-align:center">
                        <div style="font-size:28px;font-weight:700">5</div>
                        <div style="color:#6b7280">ƒê·ªôc gi·∫£</div>
                    </div>
                    <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);flex:1;min-width:180px;text-align:center">
                        <div style="font-size:28px;font-weight:700">17</div>
                        <div style="color:#6b7280">S√°ch</div>
                    </div>
                    <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);flex:1;min-width:180px;text-align:center">
                        <div style="font-size:28px;font-weight:700">28</div>
                        <div style="color:#6b7280">L∆∞·ª£t m∆∞·ª£n</div>
                    </div>
                    <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);flex:1;min-width:180px;text-align:center">
                        <div style="font-size:28px;font-weight:700">10</div>
                        <div style="color:#6b7280">Danh m·ª•c</div>
                    </div>
                </div>

                <div style="display:flex;gap:18px;flex-wrap:wrap">
                    <div style="background:#fff;border:1px solid #eef2f7;border-radius:10px;padding:18px;flex:1;min-width:300px">
                        <h3>ƒêƒÉng k√Ω ƒë·ªôc gi·∫£ theo th√°ng (2025)</h3>
                        <div style="height:220px;background:linear-gradient(180deg,#f8fafc,#fff);display:flex;align-items:center;justify-content:center;color:#9ca3af">[Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng - placeholder]</div>
                    </div>
                    <div style="background:#fff;border:1px solid #eef2f7;border-radius:10px;padding:18px;flex:1;min-width:300px">
                        <h3>L∆∞·ª£t m∆∞·ª£n s√°ch theo th√°ng (2025)</h3>
                        <div style="height:220px;background:linear-gradient(180deg,#fff,#f8fafc);display:flex;align-items:center;justify-content:center;color:#9ca3af">[Bi·ªÉu ƒë·ªì c·ªôt - placeholder]</div>
                    </div>
                </div>
            </section>

            <!-- M∆∞·ª£n - Tr·∫£ s√°ch section -->
            <section id="borrow-return-section" style="display:none">
                <h2>S√°ch ƒëang ƒë∆∞·ª£c m∆∞·ª£n</h2>
                <div class="card-surface" style="padding:18px">
                    <table class="table borrow-table" id="borrowedTable">
                        <thead>
                            <tr>
                                <th>M√£ s√°ch</th>
                                <th>T√™n s√°ch</th>
                                <th>T√°c gi·∫£</th>
                                <th>Ng√†y m∆∞·ª£n</th>
                                <th>Ng√†y tr·∫£ d·ª± ki·∫øn</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="borrowReturnTableBody">
                            <tr><td colspan="7" style="text-align:center;color:#9ca3af">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- C√†i ƒë·∫∑t: n·ªôi dung ƒë∆°n gi·∫£n gi·ªëng ·∫£nh -->
            <!-- C√†i ƒë·∫∑t -->
            <section id="settings-section" style="display:none">
                <h2>C√†i ƒë·∫∑t</h2>
                <div class="settings-grid">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <h3>Th√¥ng tin t√†i kho·∫£n</h3>
                                <p class="muted">Xem nhanh th√¥ng tin ƒëƒÉng nh·∫≠p c·ªßa b·∫°n.</p>
                            </div>
                        </div>
                        <div class="settings-fields" id="accountInfo">
                            <div class="settings-row"><span>T√™n hi·ªÉn th·ªã</span><strong id="infoFullName">--</strong></div>
                            <div class="settings-row"><span>T√™n ƒëƒÉng nh·∫≠p</span><strong id="infoUsername">--</strong></div>
                            <div class="settings-row"><span>Email</span><strong id="infoEmail">--</strong></div>
                            <div class="settings-row"><span>ƒê·ªãa ch·ªâ</span><strong id="infoAddress">--</strong></div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <h3>M·∫≠t kh·∫©u</h3>
                                <p class="muted">B·∫•m ƒë·ªïi m·∫≠t kh·∫©u khi c·∫ßn.</p>
                            </div>
                            <button type="button" class="ghost-btn" id="togglePasswordForm">ƒê·ªïi m·∫≠t kh·∫©u</button>
                        </div>
                        <form id="changePasswordForm" class="password-form" style="display:none">
                            <label for="oldPassword">M·∫≠t kh·∫©u c≈©</label>
                            <input id="oldPassword" name="oldPassword" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" required />
                            <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                            <input id="newPassword" name="newPassword" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" required />
                            <label for="confirmPassword">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
                            <input id="confirmPassword" name="confirmPassword" type="password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required />
                            <button type="submit" class="primary-btn" id="submitPasswordBtn">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <h3>Giao di·ªán</h3>
                                <p class="muted">Ch·ªçn ƒë·ªô s√°ng/t·ªëi v√† l∆∞u l·∫°i.</p>
                            </div>
                        </div>
                        <div class="theme-toggle" id="themeToggle">
                            <label><input type="radio" name="themeMode" value="light" checked> S√°ng</label>
                            <label><input type="radio" name="themeMode" value="dark"> T·ªëi</label>
                        </div>
                        <p class="muted" style="margin-top:8px">Ch·∫ø ƒë·ªô s·∫Ω ƒë∆∞·ª£c l∆∞u cho l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo.</p>
                    </div>
                </div>
            </section>

            <!-- Th·ªÉ lo·∫°i (combobox) -->
            <section id="categories-section" style="display:none">
                <h2>Th·ªÉ lo·∫°i</h2>
                <div class="card-surface" style="padding:18px;margin-bottom:12px">
                    <label for="categorySelect" style="display:block;margin-bottom:8px">Ch·ªçn th·ªÉ lo·∫°i:</label>
                    <select id="categorySelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db">
                        <option value="">-- Ch·ªçn th·ªÉ lo·∫°i --</option>
                    </select>
                </div>
                <div id="categoryBooksGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:18px"></div>
            </section>

            <!-- H·ªó tr·ª£: danh s√°ch ph·∫£n h·ªìi ng∆∞·ªùi d√πng -->
            <section id="support-section" style="display:none">
                <h2>Danh s√°ch ph·∫£n h·ªìi c·ªßa ng∆∞·ªùi d√πng</h2>
                <div class="card-surface" style="padding:18px">
                    <table class="table" id="supportTable">
                        <thead>
                            <tr><th>T√™n t√†i kho·∫£n</th><th>Ti√™u ƒë·ªÅ</th><th>N·ªôi dung</th><th>Ng√†y g·ª≠i</th><th>Thao t√°c</th></tr>
                        </thead>
                        <tbody id="supportTableBody">
                            <tr><td>user001</td><td>Thi·∫øu s√°ch</td><td>Kh√¥ng c√≥ s√°ch c·∫ßn ƒë·ªçc</td><td>20:25:46 28/11/2025</td><td><button class="primary-btn" onclick="replySupport('user001', 'Thi·∫øu s√°ch')">Ph·∫£n h·ªìi</button></td></tr>
                            <tr><td>user002</td><td>L·ªói m∆∞·ª£n</td><td>khong muon dc sach</td><td>20:25:46 28/11/2025</td><td><button class="primary-btn" onclick="replySupport('user002', 'L·ªói m∆∞·ª£n')">Ph·∫£n h·ªìi</button></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Th√¥ng b√°o -->
            <section id="notifications-section" style="display:none">
                <h2>Th√¥ng b√°o</h2>
                <div class="card-surface" style="padding:18px">
                    <div id="notificationsList"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer (m·ªõi) -->
    <footer class="site-footer" role="contentinfo">
        <div class="footer-inner">
            <p style="font-weight:800;letter-spacing:0.6px">TRUNG T√ÇM H·ªåC LI·ªÜU V√Ä H·ªñ TR·ª¢ H·ªåC THU·∫¨T, TR∆Ø·ªúNG ƒê·∫†I H·ªåC TR√Ä VINH.</p>
            <p>ƒê·ªãa ch·ªâ: 126 Nguy·ªÖn Thi·ªán Th√†nh, ph∆∞·ªùng H√≤a Thu·∫≠n, t·ªânh Vƒ©nh Long.</p>
            <p>Tel. (02943) 855 246 - 102. Email: celras@tvu.edu.vn</p>
            <div style="margin-top:10px">
                <a href="#" style="color:#fff;margin:0 8px;text-decoration:none">üîó</a>
                <a href="#" style="color:#fff;margin:0 8px;text-decoration:none">‚úâÔ∏è</a>
                <a href="#" style="color:#fff;margin:0 8px;text-decoration:none">üì°</a>
                <a href="#" style="color:#fff;margin:0 8px;text-decoration:none">‚ñ∂Ô∏è</a>
            </div>
        </div>
    </footer>

    <div id="toast" class="toast">Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn</div>

    <!-- Modal x√°c nh·∫≠n ƒëƒÉng xu·∫•t (s·ª≠ d·ª•ng l·∫°i t·ª´ project) -->
    <div id="logoutConfirm" class="logout-confirm" role="dialog" aria-modal="true" aria-labelledby="logoutTitle" aria-hidden="true">
        <div class="logout-box">
            <h3 id="logoutTitle">B·∫°n ch·∫Øc ch·∫Øn ƒëƒÉng xu·∫•t?</h3>
            <p>Phi√™n ƒëƒÉng nh·∫≠p hi·ªán t·∫°i s·∫Ω b·ªã k·∫øt th√∫c.</p>
            <div class="logout-actions">
                <button type="button" class="secondary" id="cancelLogoutBtn">H·ªßy</button>
                <button type="button" id="confirmLogoutBtn">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>

    <script>
        // Replace placeholder boxes with images from /images/<sanitized-title>.(jpg|png)
        (function(){
            function sanitizeName(s){
                return String(s||'').toLowerCase().trim()
                    .normalize('NFKD')
                    .replace(/\p{Diacritic}/gu,'')
                    .replace(/[^a-z0-9]+/gi,'-')
                    .replace(/^-+|-+$/g,'');
            }

            async function tryImage(img, title){
                const exts = ['.webp','.jpg','.png','.jpeg','.gif'];
                const candidates = [];
                const raw = String(title || '').trim();
                if (!raw) return false;
                candidates.push(encodeURIComponent(raw));
                candidates.push(encodeURIComponent(raw.replace(/\s+/g,'-')));
                const sanitized = String(raw).toLowerCase().normalize('NFKD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/gi,'-').replace(/^-+|-+$/g,'');
                candidates.push(sanitized);
                candidates.push(encodeURIComponent(raw.toLowerCase()));

                for (const c of candidates) {
                    for (const e of exts) {
                        const url = '/images/' + c + e;
                        try {
                            await new Promise((res, rej) => { img.onload = () => res(true); img.onerror = () => rej(false); img.src = url; });
                            console.debug('Found image for', title, '->', url);
                            return true;
                        } catch (err) { }
                    }
                }
                return false;
            }

            function attachGridImages(gridId){
                const grid = document.getElementById(gridId);
                if(!grid) return;
                Array.from(grid.children).forEach(card=>{
                    const children = Array.from(card.children);
                    const titleEl = children.find(c=>/font-weight:700/.test(c.getAttribute('style')||'')) || children[1] || null;
                    const placeholder = children[0] || null;
                    const title = titleEl ? titleEl.textContent.trim() : '';
                    if(!title) return;
                    const base = sanitizeName(title);
                    const img = document.createElement('img');
                    img.className = 'book-cover';
                    img.alt = title;
                    tryImage(img, base).then(found => {
                        if(found){ if(placeholder) placeholder.style.display='none'; card.insertBefore(img, card.firstChild); }
                    });
                });
            }

            document.addEventListener('DOMContentLoaded', ()=>{ attachGridImages('bookGrid'); });
        })();
        // ƒê·ªìng h·ªì ƒë∆°n gi·∫£n
        function startClock() {
            const el = document.getElementById('clock');
            setInterval(() => {
                const now = new Date();
                el.textContent = now.toLocaleString();
            }, 1000);
        }
        startClock();

        // Menu click: chuy·ªÉn section ho·∫∑c hi·ªÉn th·ªã toast
        const toast = document.getElementById('toast');
        function showToast(msg = 'Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn'){
            toast.textContent = msg;
            toast.style.display = 'block';
            toast.style.opacity = '1';
            setTimeout(()=>{ toast.style.opacity = '0'; setTimeout(()=> toast.style.display='none',300); }, 1400);
        }

        const sections = {
            dashboard: document.getElementById('dashboard-section'),
            profile: document.getElementById('profile-section'),
            search: document.getElementById('search-section'),
            categories: document.getElementById('categories-section'),
            books: document.getElementById('books-section'),
            stats: document.getElementById('stats-section'),
            settings: document.getElementById('settings-section'),
            support: document.getElementById('support-section'),
            notifications: document.getElementById('notifications-section')
        };

        const THEME_KEY = 'qltv-theme';

        function applyTheme(mode){
            const chosen = mode === 'dark' ? 'dark' : 'light';
            document.body.classList.toggle('theme-dark', chosen === 'dark');
            localStorage.setItem(THEME_KEY, chosen);
            document.querySelectorAll('input[name="themeMode"]').forEach(r => {
                r.checked = r.value === chosen;
            });
        }

        function initThemeToggle(){
            const saved = localStorage.getItem(THEME_KEY) || 'light';
            applyTheme(saved);
            const radios = document.querySelectorAll('#themeToggle input[name="themeMode"]');
            radios.forEach(r => {
                r.addEventListener('change', (e) => {
                    applyTheme(e.target.value);
                    showToast('ƒê√£ l∆∞u c√†i ƒë·∫∑t giao di·ªán');
                });
            });
        }

        async function loadAccountInfo(){
            try {
                const res = await fetch('/api/check-session.php');
                const data = await res.json();
                if (!data.loggedIn) {
                    window.location.href = 'Dangnhap.html';
                    return;
                }
                const user = data.user || {};
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value || '--';
                };
                setText('infoFullName', user.full_name || user.ho_ten || '--');
                setText('infoUsername', user.username || '--');
                setText('infoEmail', user.email || '--');
                setText('infoAddress', user.address || '--');
                setText('infoRole', user.role ? ('Lo·∫°i ' + user.role) : '--');
            } catch (e) {
                showToast('Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin t√†i kho·∫£n');
            }
        }

        function showSection(name){
            Object.keys(sections).forEach(k => {
                if (sections[k]) sections[k].style.display = (k === name) ? '' : 'none';
            });
        }

        // Header search functionality
        let searchType = null;
        const headerSearchInput = document.getElementById('headerSearchInput');
        const searchTypeDropdown = document.getElementById('searchTypeDropdown');
        
        headerSearchInput.addEventListener('click', (e) => {
            e.stopPropagation();
            searchTypeDropdown.classList.toggle('show');
        });

        document.querySelectorAll('.search-type-option').forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                searchType = option.getAttribute('data-type');
                document.querySelectorAll('.search-type-option').forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                
                headerSearchInput.readOnly = false;
                headerSearchInput.placeholder = searchType === 'book' ? 'Nh·∫≠p t√™n s√°ch...' : 'Nh·∫≠p t√™n t√°c gi·∫£...';
                headerSearchInput.value = '';
                searchTypeDropdown.classList.remove('show');
                headerSearchInput.focus();
            });
        });

        headerSearchInput.addEventListener('keyup', async (e) => {
            if (!searchType || !headerSearchInput.value.trim()) return;
            if (e.key === 'Enter') {
                const query = headerSearchInput.value.trim().toLowerCase();
                showSection('search');
                await loadAllBooks();
                
                // Get books data from API
                try {
                    const res = await fetch('/api/sach.php');
                    const data = await res.json();
                    
                    if (data.success && Array.isArray(data.data)) {
                        const filteredBooks = data.data.filter(book => {
                            if (searchType === 'book') {
                                const title = (book.ten_sach || book.ten || book.TEN || '').toLowerCase();
                                return title.includes(query);
                            } else { // author
                                const author = (book.tac_gia || book.TAC_GIA || '').toLowerCase();
                                return author.includes(query);
                            }
                        });
                        
                        renderBooks(filteredBooks);
                        showToast(`T√¨m ${searchType === 'book' ? 's√°ch' : 't√°c gi·∫£'}: "${headerSearchInput.value}" - ${filteredBooks.length} k·∫øt qu·∫£`);
                    }
                } catch (error) {
                    console.error('L·ªói t√¨m ki·∫øm:', error);
                    showToast('L·ªói t√¨m ki·∫øm');
                }
            }
        });

        document.addEventListener('click', () => {
            searchTypeDropdown.classList.remove('show');
        });

        // Header buttons
        document.getElementById('headerNotificationBtn').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('notifications');
            loadNotifications();
        });

        document.getElementById('headerAccountBtn').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('settings');
            loadAccountInfo();
        });

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = item.getAttribute('data-action');
                if (action === 'logout' || item.id === 'sidebarLogout') {
                    // m·ªü modal logout
                    document.getElementById('logoutConfirm').classList.add('show');
                    document.getElementById('logoutConfirm').setAttribute('aria-hidden','false');
                    return;
                }

                if (action === 'home') { showSection('dashboard'); return; }
                if (action === 'profile') { showSection('profile'); return; }
                if (action === 'search') { 
                    showSection('search'); 
                    const inp = document.getElementById('globalSearchInput'); 
                    if (inp) inp.focus(); 
                    loadAllBooks();
                    return; 
                }
                if (action === 'categories') { 
                    showSection('categories'); 
                    loadCategories();
                    return; 
                }
                if (action === 'books') { 
                    showSection('books'); 
                    loadBooksTable();
                    return; 
                }
                if (action === 'borrow-return') {
                    showSection('borrow-return');
                    loadBorrowReturnData('all');
                    return;
                }
                if (action === 'stats') { 
                    showSection('stats'); 
                    loadStatistics();
                    return; 
                }
                if (action === 'settings') {
                    showSection('settings');
                    loadAccountInfo();
                    return;
                }
                if (action === 'support') { 
                    showSection('support'); 
                    loadSupportRequests();
                    return; 
                }
                if (action === 'notifications') { 
                    showSection('notifications'); 
                    loadNotifications();
                    return; 
                }

                // Nh·ªØng action c√≤n l·∫°i: hi·ªán toast t·∫°m th·ªùi
                showToast('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
            });
        });

        // T√¨m ki·∫øm s√°ch - X√¢y l·∫°i t·ª´ ƒë·∫ßu
        let searchTimeout = null;
        const searchInput = document.getElementById('globalSearchInput');
        
        // H√†m t√¨m ki·∫øm s√°ch
        async function searchBooks(searchText) {
            try {
                const query = searchText ? searchText.trim() : '';
                
                // N·∫øu kh√¥ng c√≥ query, load t·∫•t c·∫£ s√°ch
                if (!query) {
                    await loadAllBooks();
                    return;
                }
                
                // G·ªçi API t√¨m ki·∫øm
                const url = `/api/search.php?q=${encodeURIComponent(query)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const responseText = await response.text();
                
                if (!responseText) {
                    throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu');
                }
                
                // Parse JSON
                const result = JSON.parse(responseText);
                
                // Ki·ªÉm tra k·∫øt qu·∫£
                if (result.success === true && Array.isArray(result.data)) {
                    renderBooks(result.data);
                    if (result.data.length === 0) {
                        showToast('Kh√¥ng t√¨m th·∫•y s√°ch n√†o');
                    }
                } else {
                    renderBooks([]);
                    showToast(result.message || 'Kh√¥ng t√¨m th·∫•y s√°ch n√†o');
                }
            } catch (error) {
                console.error('L·ªói t√¨m ki·∫øm:', error);
                showToast('L·ªói: ' + (error.message || 'Kh√¥ng th·ªÉ t√¨m ki·∫øm'));
                renderBooks([]);
            }
        }
        
        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫≠p v√†o √¥ t√¨m ki·∫øm
        if (searchInput) {
            // T√¨m ki·∫øm khi nh·∫≠p (debounce 300ms)
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // X√≥a timeout c≈©
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // T·∫°o timeout m·ªõi
                searchTimeout = setTimeout(() => {
                    searchBooks(query);
                }, 300);
            });
            
            // T√¨m ki·∫øm khi nh·∫•n Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    const query = e.target.value.trim();
                    searchBooks(query);
                }
            });
        }

        async function loadAllBooks() {
            try {
                const res = await fetch('/api/sach.php');
                
                // ƒê·ªçc response text tr∆∞·ªõc
                const text = await res.text();
                
                // Ki·ªÉm tra n·∫øu response kh√¥ng ph·∫£i JSON
                if (!text.trim().startsWith('{') && !text.trim().startsWith('[')) {
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
                }
                
                // Parse JSON
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response text:', text.substring(0, 500));
                    throw new Error('Kh√¥ng th·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ server');
                }
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                if (data.success && Array.isArray(data.data)) {
                    renderBooks(data.data);
                } else {
                    renderBooks([]);
                    showToast(data.message || 'Kh√¥ng c√≥ d·ªØ li·ªáu s√°ch');
                }
            } catch (e) {
                console.error('Load books error:', e);
                showToast('L·ªói t·∫£i s√°ch: ' + (e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                renderBooks([]);
            }
        }

        // H√†m t·∫°o URL ·∫£nh t·ª± ƒë·ªông cho s√°ch ch∆∞a c√≥ ·∫£nh
        function getBookImageUrl(book) {
            if (book.anh_bia && book.anh_bia.trim() !== '') {
                return book.anh_bia;
            }
            // T·∫°o URL ·∫£nh placeholder d·ª±a tr√™n ID s√°ch
            const bookId = book.ID || book.id || 'default';
            return `https://via.placeholder.com/200x280/4F46E5/FFFFFF?text=${encodeURIComponent(book.ten_sach || 'Book')}`;
        }

        function renderBooks(books) {
            const grid = document.getElementById('bookGrid');
            if (!grid) return;
            
            if (!books || books.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#6b7280">Kh√¥ng c√≥ s√°ch n√†o</div>';
                return;
            }
            
            grid.innerHTML = books.map(book => {
                const imageUrl = getBookImageUrl(book);
                const bookId = book.ID || book.id || book.ID_sach || '';
                return `
                <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9;cursor:pointer" data-book-id="${bookId}">
                    <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;overflow:hidden">
                        <img src="${imageUrl}" style="max-width:100%;max-height:100%;object-fit:cover;border-radius:6px" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'color:#6b7280\\'>·∫¢nh</div>'" />
                    </div>
                    <div style="font-weight:700">${book.ten_sach || book.ten || book.TEN || ''}</div>
                </div>
            `;
            }).join('');
            
            // Th√™m event listener cho click
            grid.querySelectorAll('[data-book-id]').forEach(card => {
                card.addEventListener('click', () => {
                    const bookId = card.getAttribute('data-book-id');
                    const book = books.find(b => (b.ID && String(b.ID) === String(bookId)) || (b.id && String(b.id) === String(bookId)) || (b.ID_sach && String(b.ID_sach) === String(bookId)));
                    if (book) openBookModal(book);
                });
            });
        }

            async function loadCategories() {
                try {
                    const res = await fetch('/api/categories.php');
                    const data = await res.json();
                    if (data.success) {
                        const select = document.getElementById('categorySelect');
                        if (select) {
                            select.innerHTML = '<option value="">-- Ch·ªçn th·ªÉ lo·∫°i --</option>' + (data.data || []).map(cat => `<option value="${cat.ten_danh_muc}">${cat.ten_danh_muc}</option>`).join('');
                            // attach onchange once (replace any previous handler)
                            select.onchange = function(e) { const v = (e.target && e.target.value) ? e.target.value : ''; if (v) loadBooksByCategory(v); };
                            // Build category->price mapping for display codes
                            window.categoryPriceMap = {};
                            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                            (data.data || []).forEach((cat, idx) => {
                                const prefix = letters[idx] ? (letters[idx] + '1') : ('X' + (idx+1));
                                window.categoryPriceMap[cat.ten_danh_muc] = prefix;
                            });
                        }
                    }
                } catch (e) {
                    showToast('L·ªói t·∫£i danh m·ª•c');
                }
            }

        async function loadBooksByCategory(category) {
            try {
                const res = await fetch(`/api/search.php?category=${encodeURIComponent(category)}`);
                const data = await res.json();
                if (data.success) {
                    const grid = document.getElementById('categoryBooksGrid');
                    if (grid) {
                        grid.innerHTML = data.data.map(book => `
                            <div style="background:#fff;border-radius:10px;padding:12px;text-align:center;border:1px solid #f1f5f9;cursor:pointer" data-book-id="${book.ID}">
                                <div style="height:140px;background:#f3f4f6;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                    <img src="${getBookImageUrl(book)}" style="max-width:100%;max-height:100%;object-fit:cover;border-radius:6px" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'color:#6b7280\\'>·∫¢nh</div>'" />
                                </div>
                                <div style="font-weight:700">${book.ten_sach || ''}</div>
                            </div>
                        `).join('');
                        
                        grid.querySelectorAll('[data-book-id]').forEach(card => {
                            card.addEventListener('click', () => {
                                const bookId = card.getAttribute('data-book-id');
                                const book = data.data.find(b => b.ID === bookId);
                                if (book) openBookModal(book);
                            });
                        });
                    }
                }
            } catch (e) {
                showToast('L·ªói t·∫£i s√°ch theo th·ªÉ lo·∫°i');
            }
        }

        async function loadNotifications() {
            try {
                const res = await fetch('/api/notifications.php');
                const data = await res.json();
                if (data.success) {
                    const list = document.getElementById('notificationsList');
                    if (list) {
                        if (data.data.length === 0) {
                            list.innerHTML = '<p style="color:#6b7280">Ch∆∞a c√≥ th√¥ng b√°o n√†o</p>';
                        } else {
                            list.innerHTML = data.data.map(notif => `
                                <div style="border-bottom:1px solid #e5e7eb;padding:12px 0">
                                    <p style="margin:0 0 8px 0"><strong>Ph·∫£n h·ªìi t·ª´: ${notif.replied_by || 'Admin'}</strong></p>
                                    <p style="margin:0 0 4px 0;color:#374151">${notif.reply || ''}</p>
                                    <p style="margin:0;color:#6b7280;font-size:12px">${notif.created_at || ''}</p>
                                </div>
                            `).join('');
                        }
                    }
                }
            } catch (e) {
                showToast('L·ªói t·∫£i th√¥ng b√°o');
            }
        }

        async function loadSupportRequests() {
            try {
                const res = await fetch('/api/support.php');
                const data = await res.json();
                if (data.success) {
                    const tbody = document.getElementById('supportTableBody');
                    if (tbody) {
                        if (data.data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#6b7280">Ch∆∞a c√≥ y√™u c·∫ßu h·ªó tr·ª£ n√†o</td></tr>';
                        } else {
                            tbody.innerHTML = data.data.map(req => `
                                <tr>
                                    <td>${req.username || 'Unknown'}</td>
                                    <td>${req.title || '-'}</td>
                                    <td>
                                        ${req.details || '-'}
                                        ${req.screenshot ? `<br><a href="${req.screenshot}" target="_blank" style="color:#3b82f6">Xem ·∫£nh</a>` : ''}
                                    </td>
                                    <td>${req.created_at || '-'}</td>
                                    <td>
                                        <button class="primary-btn" onclick="replySupport('${req.username}', '${req.title}')">Ph·∫£n h·ªìi</button>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    }
                }
            } catch (e) {
                console.error('L·ªói t·∫£i y√™u c·∫ßu h·ªó tr·ª£:', e);
                showToast('L·ªói t·∫£i y√™u c·∫ßu h·ªó tr·ª£');
            }
        }

        function openBookModal(book) {
            const modal = document.getElementById('bookDetailModal');
            const modalTitle = document.getElementById('bookDetailTitle');
            const modalBody = document.getElementById('bookDetailBody');
            if (!modal || !modalTitle || !modalBody) return;
            
            modalTitle.textContent = book.ten_sach || 'S√°ch';
            const imageUrl = getBookImageUrl(book);
            const formattedPrice = formatPrice(book.vi_tri || '');
            modalBody.innerHTML = `
                <div style="text-align:center;margin-bottom:20px">
                    <img src="${imageUrl}" style="max-width:200px;max-height:280px;object-fit:cover;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1)" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'padding:40px;color:#6b7280\\'>Kh√¥ng c√≥ ·∫£nh</div>'" />
                </div>
                <p><strong>M√£ s√°ch:</strong> ${book.ID || '-'}</p>
                <p><strong>T√°c gi·∫£:</strong> ${book.tac_gia || '-'}</p>
                <p><strong>NƒÉm XB:</strong> ${book.nam_xuat_ban || '-'}</p>
                <p><strong>Gi√° s√°ch:</strong> ${formattedPrice}</p>
                <p><strong>S·ªë l∆∞·ª£ng c√≤n:</strong> <span id="modalAvailable">${book.so_luong ?? '-'}</span></p>
            `;
            modal.classList.add('show');
            modal.setAttribute('aria-hidden','false');
            
            // L∆∞u book hi·ªán t·∫°i
            window.currentBook = book;
        }

        function replySupport(username, title) {
            const reply = prompt(`Ph·∫£n h·ªìi cho ${username} v·ªÅ "${title}":`);
            if (reply && reply.trim()) {
                fetch('/api/reply-support.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        support_id: title,
                        username: username,
                        reply: reply.trim()
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('ƒê√£ g·ª≠i ph·∫£n h·ªìi th√†nh c√¥ng');
                    } else {
                        showToast('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi'));
                    }
                })
                .catch(e => showToast('L·ªói k·∫øt n·ªëi'));
            }
        }

        // Refresh profile
        document.getElementById('refreshProfileBtn').addEventListener('click', ()=>{
            showToast('ƒê√£ l√†m m·ªõi danh s√°ch');
        });

        // Logout handling (POST to existing API)
        const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
        const logoutConfirm = document.getElementById('logoutConfirm');

        cancelLogoutBtn.addEventListener('click', ()=>{
            logoutConfirm.classList.remove('show');
            logoutConfirm.setAttribute('aria-hidden','true');
        });

        confirmLogoutBtn.addEventListener('click', async ()=>{
            try{
                const res = await fetch('/api/logout.php', { method: 'POST' });
                const data = await res.json();
                window.location.href = 'Dangnhap.html';
            } catch(e){ window.location.href = 'Dangnhap.html'; }
        });

        // Password form handlers
        const togglePasswordFormBtn = document.getElementById('togglePasswordForm');
        const passwordForm = document.getElementById('changePasswordForm');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');

        if (togglePasswordFormBtn && passwordForm) {
            togglePasswordFormBtn.addEventListener('click', () => {
                const isHidden = passwordForm.style.display === 'none' || passwordForm.style.display === '';
                passwordForm.style.display = isHidden ? 'block' : 'none';
            });
        }

        if (passwordForm) {
            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const oldPass = document.getElementById('oldPassword').value.trim();
                const newPass = document.getElementById('newPassword').value.trim();
                const confirmPass = document.getElementById('confirmPassword').value.trim();

                if (!oldPass || !newPass || !confirmPass) {
                    showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
                    return;
                }
                if (newPass !== confirmPass) {
                    showToast('M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp');
                    return;
                }
                if (newPass.length < 6) {
                    showToast('M·∫≠t kh·∫©u m·ªõi t·ªëi thi·ªÉu 6 k√Ω t·ª±');
                    return;
                }

                submitPasswordBtn.disabled = true;
                submitPasswordBtn.textContent = 'ƒêang c·∫≠p nh·∫≠t...';
                try {
                    const res = await fetch('/api/change-password.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            old_password: oldPass,
                            new_password: newPass,
                            confirm_password: confirmPass
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        // L∆∞u m·∫≠t kh·∫©u m·ªõi v√†o localStorage (offline mode)
                        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                        if (currentUser.username) {
                            const offlineUsers = JSON.parse(localStorage.getItem('offlineUsers') || '{}');
                            offlineUsers[currentUser.username] = newPass;
                            localStorage.setItem('offlineUsers', JSON.stringify(offlineUsers));
                        }
                        showToast('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng');
                        passwordForm.reset();
                        passwordForm.style.display = 'none';
                    } else {
                        showToast(data.message || 'Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u');
                    }
                } catch (err) {
                    showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß');
                }
                submitPasswordBtn.disabled = false;
                submitPasswordBtn.textContent = 'C·∫≠p nh·∫≠t m·∫≠t kh·∫©u';
            });
        }

        // Kh·ªüi ƒë·ªông: (n·∫øu c·∫ßn) ki·ªÉm tra session c∆° b·∫£n
        (async function checkSession() {
            try{
                const r = await fetch('/api/check-session.php');
                const d = await r.json();
                if (!d.loggedIn) window.location.href = 'Dangnhap.html';
            }catch(e){ /* n·∫øu kh√¥ng c√≥ API th√¨ b·ªè qua */ }
        })();

        initThemeToggle();
    </script>

    <!-- Modal chi ti·∫øt s√°ch + logic m∆∞·ª£n -->
    <div id="bookDetailModal" class="logout-confirm" role="dialog" aria-modal="true" aria-labelledby="bookDetailTitle" aria-hidden="true">
        <div class="logout-box">
            <h3 id="bookDetailTitle">Chi ti·∫øt s√°ch</h3>
            <div id="bookDetailBody" style="margin:12px 0"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button id="modalCancelBtn" class="secondary">H·ªßy</button>
                <button id="modalBorrowBtn" class="primary-btn">M∆∞·ª£n s√°ch</button>
            </div>
        </div>
    </div>

    <script>
        (function(){
            let booksCache = null;
            async function loadBooksCache(){
                if (booksCache) return booksCache;
                try{
                    const res = await fetch('/api/sach.php');
                    const j = await res.json();
                    if (j.success && Array.isArray(j.data)) booksCache = j.data;
                    else booksCache = [];
                }catch(e){ booksCache = []; }
                return booksCache;
            }

            function findBookById(id){
                if (!booksCache) return null;
                return booksCache.find(b => (b.ID && String(b.ID) === String(id)) || (b.id && String(b.id) === String(id)) || (b.ID_sach && String(b.ID_sach) === String(id)) );
            }

            function findBookByTitle(title){
                if (!booksCache) return null;
                const t = String(title).toLowerCase();
                return booksCache.find(b => (b.ten_sach && String(b.ten_sach).toLowerCase().includes(t)) || (b.ten && String(b.ten).toLowerCase().includes(t)) || (b.TEN && String(b.TEN).toLowerCase().includes(t)) );
            }

            const modal = document.getElementById('bookDetailModal');
            const modalTitle = document.getElementById('bookDetailTitle');
            const modalBody = document.getElementById('bookDetailBody');
            const borrowBtn = document.getElementById('modalBorrowBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            let currentBook = null;

            function openModal(book){
                currentBook = book;
                modalTitle.textContent = book.ten_sach || book.ten || book.TEN || ('S√°ch ' + (book.ID || ''));
                const imageUrl = getBookImageUrl(book);
                const formattedPrice = formatPrice(book.vi_tri || '');
                modalBody.innerHTML = `
                    <div style="text-align:center;margin-bottom:20px">
                        <img src="${imageUrl}" style="max-width:200px;max-height:280px;object-fit:cover;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1)" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'padding:40px;color:#6b7280\\'>Kh√¥ng c√≥ ·∫£nh</div>'" />
                    </div>
                    <p><strong>M√£ s√°ch:</strong> ${book.ID || book.id || book.ID_sach || '-'}</p>
                    <p><strong>M√£ gi√° s√°ch:</strong> ${ (window.categoryPriceMap && window.categoryPriceMap[book.danh_muc]) ? (window.categoryPriceMap[book.danh_muc] + '.' + (book.ID || book.id || '')) : ('X1.' + (book.ID || book.id || '')) }</p>
                    <p><strong>T√°c gi·∫£:</strong> ${book.tac_gia || book.TAC_GIA || '-'}</p>
                    <p><strong>NƒÉm XB:</strong> ${book.nam_xuat_ban || '-'}</p>
                    <p><strong>Gi√° s√°ch:</strong> ${formattedPrice}</p>
                    <p><strong>S·ªë l∆∞·ª£ng c√≤n:</strong> <span id="modalAvailable">${book.so_luong ?? (book.soLuong ?? '-')}</span></p>
                `;
                modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
            }
            function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

            cancelBtn.addEventListener('click', closeModal);

            borrowBtn.addEventListener('click', async ()=>{
                if (!currentBook) return;
                borrowBtn.disabled = true; borrowBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                try{
                    const res = await fetch('/api/borrow.php', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_sach: currentBook.ID || currentBook.id || currentBook.ID_sach })
                    });
                    const j = await res.json();
                    if (j.success){
                        const avail = document.getElementById('modalAvailable');
                        if (avail && typeof j.data !== 'undefined') avail.textContent = j.data.so_luong_con_lai;

                        // update table rows if present
                        const rows = document.querySelectorAll('table.table tbody tr');
                        rows.forEach(r=>{
                            const idCell = r.querySelector('td');
                            if (!idCell) return;
                            if (String(idCell.textContent).trim() === String(currentBook.ID || currentBook.id || currentBook.ID_sach)){
                                const statusCell = r.children[6];
                                if (statusCell) statusCell.textContent = (j.data.so_luong_con_lai <= 0) ? 'ƒêang m∆∞·ª£n' : 'C√≥ s·∫µn';
                            }
                        });

                        showToast('M∆∞·ª£n s√°ch th√†nh c√¥ng');
                        closeModal();
                    } else {
                        showToast('L·ªói: ' + (j.message || 'Kh√¥ng th·ªÉ m∆∞·ª£n s√°ch'));
                    }
                }catch(e){
                    showToast('L·ªói k·∫øt n·ªëi khi m∆∞·ª£n');
                }
                borrowBtn.disabled = false; borrowBtn.textContent = 'M∆∞·ª£n s√°ch';
            });

            // Delegated: bookGrid cards
            const grid = document.getElementById('bookGrid');
            if (grid){
                grid.addEventListener('click', async (e)=>{
                    const card = e.target.closest('div[style]');
                    if (!card) return;
                    const titleEl = card.querySelector('div[style] + div') || card.querySelector('strong') || card.querySelector('div');
                    const title = titleEl ? titleEl.textContent.trim() : '';
                    await loadBooksCache();
                    let book = findBookByTitle(title);
                    if (book) openModal(book);
                    else showToast('Kh√¥ng t√¨m th·∫•y th√¥ng tin s√°ch trong DB');
                });
            }

            // Delegated click for table rows
            document.addEventListener('click', async (e)=>{
                const row = e.target.closest('table.table tbody tr');
                if (!row) return;
                if (e.target.tagName.toLowerCase() === 'button') return;
                const idCell = row.querySelector('td');
                if (!idCell) return;
                const id = idCell.textContent.trim();
                await loadBooksCache();
                const book = findBookById(id);
                if (book) openModal(book);
            });

            loadBooksCache();
        })();

        // H√†m format gi√° s√°ch (r√∫t g·ªçn n·∫øu qu√° d√†i)
        function formatPrice(priceStr) {
            if (!priceStr || priceStr.trim() === '') return '-';
            if (priceStr === 'C√≥ s·∫µn' || priceStr === 'ƒêang m∆∞·ª£n' || priceStr === 'H·∫øt s√°ch') return priceStr;
            
            if (priceStr.includes('Gi√°:')) {
                const parts = priceStr.split('Gi√°:');
                if (parts.length > 1) {
                    const priceValue = parts[1].trim();
                    const match = priceValue.match(/^([\d.]+)/);
                    if (match) {
                        return 'Gi√°: ' + match[1];
                    }
                    return 'Gi√°: ' + priceValue.substring(0, 20);
                }
            }
            return priceStr.length > 25 ? priceStr.substring(0, 22) + '...' : priceStr;
        }

        // Load v√† hi·ªÉn th·ªã s√°ch trong b·∫£ng
        async function loadBooksTable() {
            try {
                const res = await fetch('/api/sach.php');
                const text = await res.text();
                if (!text) throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu');
                
                const result = JSON.parse(text);
                if (result.success && Array.isArray(result.data)) {
                    renderBooksTable(result.data);
                } else {
                    const tbody = document.getElementById('booksTableBody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:#6b7280">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                }
            } catch (error) {
                console.error('L·ªói load s√°ch:', error);
                showToast('L·ªói t·∫£i danh s√°ch s√°ch');
            }
        }

        // Render b·∫£ng s√°ch
        function renderBooksTable(books) {
            const tbody = document.getElementById('booksTableBody');
            if (!tbody) return;

            if (!books || books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;color:#6b7280">Kh√¥ng c√≥ s√°ch n√†o</td></tr>';
                return;
            }

            // cache for edit modal lookup
            window.booksCache = books;

            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

            tbody.innerHTML = books.map((book, idx) => {
                const price = formatPrice(book.vi_tri || book.gia_sach || '');
                const qty = (typeof book.so_luong !== 'undefined') ? book.so_luong : (typeof book.soLuong !== 'undefined' ? book.soLuong : '-');
                const status = book.trang_thai || (qty !== '-' && Number(qty) > 0 ? 'C√≥ s·∫µn' : 'H·∫øt s√°ch');
                const cat = book.danh_muc || book.category || '';
                const prefix = (window.categoryPriceMap && window.categoryPriceMap[cat]) ? window.categoryPriceMap[cat] : (letters[idx] ? (letters[idx] + '1') : ('X' + (idx+1)));
                const priceCode = prefix + '.' + (book.ID || book.id || ('#' + (idx+1)));

                return `
                    <tr>
                        <td>${book.ID || book.id || '-'}</td>
                        <td>${book.ten_sach || book.ten || '-'}</td>
                        <td>${book.tac_gia || '-'}</td>
                        <td>${book.nam_xuat_ban || '-'}</td>
                        <td>${book.ngon_ngu || '-'}</td>
                        <td>${cat}</td>
                        <td>${qty}</td>
                        <td>${priceCode}</td>
                        <td>${status}</td>
                        <td>
                            <button class="secondary" onclick="openEditBookModal('${book.ID || book.id || ''}')">S·ª≠a</button>
                            <button style="background:#ef4444;color:#fff;border-radius:6px;padding:6px 8px;margin-left:6px" onclick="deleteBook('${book.ID || book.id || ''}')">X√≥a</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        const addBookModal = document.getElementById('addBookModal');
        const addBookCancelBtn = document.getElementById('addBookCancelBtn');
        const addBookSaveBtn = document.getElementById('addBookSaveBtn');
        const addBookIdInput = document.getElementById('addBookId');
        const bookIdError = document.getElementById('bookIdError');

        function openAddBookModal() {
            if (!addBookModal) return;
            document.getElementById('addBookId').value = '';
            document.getElementById('addBookName').value = '';
            document.getElementById('addBookAuthor').value = '';
            document.getElementById('addBookYear').value = '';
            document.getElementById('addBookLanguage').value = 'Ti·∫øng Vi·ªát';
            document.getElementById('addBookCategory').value = 'C√¥ng ngh·ªá th√¥ng tin';
            document.getElementById('addBookPrice').value = '';
            document.getElementById('addBookQuantity').value = '0';
            if (bookIdError) bookIdError.style.display = 'none';
            addBookModal.classList.add('show');
            addBookModal.setAttribute('aria-hidden', 'false');
        }

        function closeAddBookModal() {
            if (!addBookModal) return;
            addBookModal.classList.remove('show');
            addBookModal.setAttribute('aria-hidden', 'true');
        }

        async function checkBookIdExists(bookId) {
            try {
                const res = await fetch('/api/sach.php');
                const text = await res.text();
                const result = JSON.parse(text);
                if (result.success && Array.isArray(result.data)) {
                    return result.data.some(book => book.ID === bookId);
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        if (addBookBtn) {
            addBookBtn.addEventListener('click', openAddBookModal);
        }

        if (addBookCancelBtn) {
            addBookCancelBtn.addEventListener('click', closeAddBookModal);
        }

        if (addBookIdInput) {
            addBookIdInput.addEventListener('blur', async function() {
                const bookId = this.value.trim();
                if (bookId && bookIdError) {
                    const exists = await checkBookIdExists(bookId);
                    if (exists) {
                        bookIdError.textContent = 'M√£ s√°ch ƒë√£ t·ªìn t·∫°i';
                        bookIdError.style.display = 'block';
                        this.style.borderColor = '#ef4444';
                    } else {
                        bookIdError.style.display = 'none';
                        this.style.borderColor = '#d1d5db';
                    }
                } else if (bookIdError) {
                    bookIdError.style.display = 'none';
                    this.style.borderColor = '#d1d5db';
                }
            });
        }

        if (addBookSaveBtn) {
            addBookSaveBtn.addEventListener('click', async function() {
                const bookId = document.getElementById('addBookId').value.trim();
                const bookName = document.getElementById('addBookName').value.trim();
                const bookAuthor = document.getElementById('addBookAuthor').value.trim();
                const bookYear = document.getElementById('addBookYear').value;
                const bookLanguage = document.getElementById('addBookLanguage').value;
                const bookCategory = document.getElementById('addBookCategory').value;
                const bookPrice = document.getElementById('addBookPrice').value.trim();
                const bookQuantity = parseInt(document.getElementById('addBookQuantity').value) || 0;

                if (!bookId || !bookName || !bookAuthor) {
                    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
                    return;
                }

                const isEdit = window.editingBookId && window.editingBookId === bookId;

                if (!isEdit) {
                    const exists = await checkBookIdExists(bookId);
                    if (exists) {
                        if (bookIdError) {
                            bookIdError.textContent = 'M√£ s√°ch ƒë√£ t·ªìn t·∫°i';
                            bookIdError.style.display = 'block';
                        }
                        if (addBookIdInput) addBookIdInput.style.borderColor = '#ef4444';
                        return;
                    }
                }

                addBookSaveBtn.disabled = true;
                addBookSaveBtn.textContent = isEdit ? 'ƒêang c·∫≠p nh·∫≠t...' : 'ƒêang th√™m...';

                try {
                    if (isEdit) {
                        // Update existing book
                        const response = await fetch('/api/update-book.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ID: window.editingBookId,
                                ten_sach: bookName,
                                tac_gia: bookAuthor,
                                nam_xuat_ban: bookYear ? parseInt(bookYear) : null,
                                ngon_ngu: bookLanguage,
                                danh_muc: bookCategory,
                                gia_sach: bookPrice,
                                so_luong: bookQuantity
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast('C·∫≠p nh·∫≠t s√°ch th√†nh c√¥ng');
                            closeAddBookModal();
                            loadBooksTable();
                            window.editingBookId = null;
                            addBookSaveBtn.textContent = 'Th√™m s√°ch';
                        } else {
                            showToast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s√°ch'));
                        }
                    } else {
                        // Add new book
                        const response = await fetch('/api/add-book.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ID: bookId,
                                ten_sach: bookName,
                                tac_gia: bookAuthor,
                                nam_xuat_ban: bookYear ? parseInt(bookYear) : null,
                                ngon_ngu: bookLanguage,
                                danh_muc: bookCategory,
                                gia_sach: bookPrice,
                                so_luong: bookQuantity
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            showToast('Th√™m s√°ch th√†nh c√¥ng');
                            closeAddBookModal();
                            loadBooksTable();
                        } else {
                            showToast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ th√™m s√°ch'));
                        }
                    }
                } catch (error) {
                    console.error('L·ªói th√™m/c·∫≠p nh·∫≠t s√°ch:', error);
                    showToast('L·ªói k·∫øt n·ªëi');
                }

                addBookSaveBtn.disabled = false;
                addBookSaveBtn.textContent = 'Th√™m s√°ch';
            });
        }

        // Open edit modal for a given book ID
        function openEditBookModal(id) {
            if (!id) return showToast('ID s√°ch kh√¥ng h·ª£p l·ªá');
            (async () => {
                try {
                    if (!window.booksCache) await (async function(){ const r = await fetch('/api/sach.php'); const t = await r.text(); const j = JSON.parse(t); window.booksCache = (j.success && Array.isArray(j.data)) ? j.data : []; })();
                    const book = (window.booksCache || []).find(b => String(b.ID) === String(id) || String(b.id) === String(id));
                    if (!book) return showToast('Kh√¥ng t√¨m th·∫•y s√°ch ƒë·ªÉ ch·ªânh s·ª≠a');

                    // Prefill modal fields
                    document.getElementById('addBookId').value = book.ID || book.id || '';
                    document.getElementById('addBookName').value = book.ten_sach || book.ten || '';
                    document.getElementById('addBookAuthor').value = book.tac_gia || '';
                    document.getElementById('addBookYear').value = book.nam_xuat_ban || '';
                    document.getElementById('addBookLanguage').value = book.ngon_ngu || 'Ti·∫øng Vi·ªát';
                    document.getElementById('addBookCategory').value = book.danh_muc || '';
                    document.getElementById('addBookPrice').value = book.gia_sach || book.vi_tri || '';
                    document.getElementById('addBookQuantity').value = book.so_luong ?? book.soLuong ?? 0;

                    window.editingBookId = book.ID || book.id || '';
                    addBookSaveBtn.textContent = 'C·∫≠p nh·∫≠t';
                    if (bookIdError) bookIdError.style.display = 'none';
                    addBookModal.classList.add('show');
                    addBookModal.setAttribute('aria-hidden','false');
                } catch (e) {
                    console.error(e);
                    showToast('L·ªói khi m·ªü modal ch·ªânh s·ª≠a');
                }
            })();
        }

        // Delete book (attempt API, otherwise notify)
        async function deleteBook(id) {
            if (!id) return showToast('ID s√°ch kh√¥ng h·ª£p l·ªá');
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s√°ch n√†y?')) return;
            try {
                const res = await fetch('/api/delete-book.php', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ID: id })
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const j = await res.json();
                if (j.success) {
                    showToast('X√≥a s√°ch th√†nh c√¥ng');
                    loadBooksTable();
                } else {
                    showToast('L·ªói: ' + (j.message || 'Kh√¥ng th·ªÉ x√≥a s√°ch'));
                }
            } catch (e) {
                console.warn('Delete API error or not implemented', e);
                showToast('X√≥a t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng');
            }
        }

        if (addBookModal) {
            addBookModal.addEventListener('click', (e) => {
                if (e.target === addBookModal) {
                    closeAddBookModal();
                }
            });
        }
    </script>

    <!-- Modal th√™m s√°ch m·ªõi -->
    <div id="addBookModal" class="logout-confirm" role="dialog" aria-modal="true" aria-labelledby="addBookTitle" aria-hidden="true">
        <div class="logout-box" style="max-width:700px;padding:30px;max-height:90vh;overflow-y:auto">
            <h3 id="addBookTitle" style="margin-bottom:24px;font-size:20px;color:#111827">Th√™m s√°ch m·ªõi</h3>
            <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:24px;margin-bottom:20px">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">M√£ s√°ch <span style="color:#ef4444">*</span>:</label>
                        <input type="text" id="addBookId" placeholder="VD: 200" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff" />
                        <div id="bookIdError" style="color:#ef4444;font-size:12px;margin-top:4px;display:none"></div>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">NƒÉm xu·∫•t b·∫£n:</label>
                        <input type="number" id="addBookYear" placeholder="VD: 2024" min="1000" max="2100" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff" />
                    </div>
                    <div style="grid-column:1/-1">
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">T√™n s√°ch <span style="color:#ef4444">*</span>:</label>
                        <input type="text" id="addBookName" placeholder="Nh·∫≠p t√™n s√°ch" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff" />
                    </div>
                    <div style="grid-column:1/-1">
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">T√°c gi·∫£ <span style="color:#ef4444">*</span>:</label>
                        <input type="text" id="addBookAuthor" placeholder="Nh·∫≠p t√™n t√°c gi·∫£" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff" />
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">Ng√¥n ng·ªØ:</label>
                        <select id="addBookLanguage" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff">
                            <option value="Ti·∫øng Vi·ªát">Ti·∫øng Vi·ªát</option>
                            <option value="Ti·∫øng Anh">Ti·∫øng Anh</option>
                            <option value="Ti·∫øng Ph√°p">Ti·∫øng Ph√°p</option>
                            <option value="Ti·∫øng Nh·∫≠t">Ti·∫øng Nh·∫≠t</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">Th·ªÉ lo·∫°i:</label>
                        <select id="addBookCategory" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff">
                            <option value="C√¥ng ngh·ªá th√¥ng tin">C√¥ng ngh·ªá th√¥ng tin</option>
                            <option value="Kinh t·∫ø">Kinh t·∫ø</option>
                            <option value="Khoa h·ªçc - K·ªπ thu·∫≠t">Khoa h·ªçc - K·ªπ thu·∫≠t</option>
                            <option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option>
                            <option value="VƒÉn h·ªçc">VƒÉn h·ªçc</option>
                            <option value="T√¢m l√Ω">T√¢m l√Ω</option>
                            <option value="Kinh doanh">Kinh doanh</option>
                            <option value="To√°n - Tin">To√°n - Tin</option>
                            <option value="Ph√°t tri·ªÉn c√° nh√¢n">Ph√°t tri·ªÉn c√° nh√¢n</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">Gi√° s√°ch:</label>
                        <input type="text" id="addBookPrice" placeholder="VD: 810.264" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff" />
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px">S·ªë l∆∞·ª£ng:</label>
                        <input type="number" id="addBookQuantity" placeholder="0" min="0" value="0" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff" />
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button id="addBookCancelBtn" class="secondary">H·ªßy</button>
                <button id="addBookSaveBtn" class="primary-btn">Th√™m s√°ch</button>
            </div>
        </div>
    </div>

    <!-- Script for Borrow-Return Management -->
    <script>
        let currentBorrowFilter = 'all';
        let borrowReturnData = [];
        let usersData = [];

        // Load borrowed books for all users with status combobox
        async function loadBorrowReturnData(filter = 'all') {
            const tbody = document.getElementById('borrowReturnTableBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af">ƒêang t·∫£i...</td></tr>';

            try {
                // Load borrow-return data
                const borrowRes = await fetch('/api/muon_tra.php');
                const borrowJson = await borrowRes.json();
                borrowReturnData = (borrowJson.success && Array.isArray(borrowJson.data)) ? borrowJson.data : [];

                // Load users data to get names
                const usersRes = await fetch('/api/nguoidung.php');
                const usersJson = await usersRes.json();
                usersData = (usersJson.success && Array.isArray(usersJson.data)) ? usersJson.data : [];

                // Render table
                if (borrowReturnData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }

                tbody.innerHTML = borrowReturnData.map(item => {
                    const user = usersData.find(u => u.ID === item.ID_nguoi_dung || u.id === item.ID_nguoi_dung);
                    const userName = user ? (user.ho_ten || user.username || item.ID_nguoi_dung) : item.ID_nguoi_dung;
                    const currentStatus = item.trang_thai || 'ƒêang m∆∞·ª£n';
                    
                    return `
                        <tr data-id="${item.ID_muon_tra}">
                            <td>${item.ID_sach || '-'}</td>
                            <td>${item.ten_sach || '-'}</td>
                            <td>${user ? (user.ho_ten || user.username) : '-'}</td>
                            <td>${item.ngay_muon || '-'}</td>
                            <td>${item.ngay_tra_du_kien || '-'}</td>
                            <td>
                                <select class="status-select" data-id="${item.ID_muon_tra}" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;cursor:pointer">
                                    <option value="ƒêang m∆∞·ª£n" ${currentStatus === 'ƒêang m∆∞·ª£n' ? 'selected' : ''}>ƒêang m∆∞·ª£n</option>
                                    <option value="Ch·ªù x√°c nh·∫≠n tr·∫£" ${currentStatus === 'Ch·ªù x√°c nh·∫≠n tr·∫£' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n tr·∫£</option>
                                    <option value="ƒê√£ tr·∫£" ${currentStatus === 'ƒê√£ tr·∫£' ? 'selected' : ''}>ƒê√£ tr·∫£</option>
                                </select>
                            </td>
                            <td><button class="secondary" onclick="viewBorrowDetail('${item.ID_muon_tra}')">Chi ti·∫øt</button></td>
                        </tr>
                    `;
                }).join('');

                // Add event listeners to status selects
                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', handleStatusChange);
                });

            } catch (error) {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu m∆∞·ª£n-tr·∫£:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#ef4444">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        // Handle status change
        async function handleStatusChange(event) {
            const select = event.target;
            const id = select.getAttribute('data-id');
            const newStatus = select.value;

            if (!confirm(`X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i th√†nh "${newStatus}"?`)) {
                // Reset to original value
                const item = borrowReturnData.find(b => b.ID_muon_tra === id);
                if (item) select.value = item.trang_thai || 'ƒêang m∆∞·ª£n';
                return;
            }

            try {
                const res = await fetch('/api/update-borrow-status.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ID_muon_tra: id, trang_thai: newStatus })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng');
                    // Update local data
                    const item = borrowReturnData.find(b => b.ID_muon_tra === id);
                    if (item) item.trang_thai = newStatus;
                } else {
                    showToast(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i');
                    // Reset to original value
                    const item = borrowReturnData.find(b => b.ID_muon_tra === id);
                    if (item) select.value = item.trang_thai || 'ƒêang m∆∞·ª£n';
                }
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
                showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß');
                // Reset to original value
                const item = borrowReturnData.find(b => b.ID_muon_tra === id);
                if (item) select.value = item.trang_thai || 'ƒêang m∆∞·ª£n';
            }
        }

        function viewBorrowDetail(id) {
            const item = borrowReturnData.find(b => b.ID_muon_tra === id);
            if (!item) return;
            const user = usersData.find(u => u.ID === item.ID_nguoi_dung || u.id === item.ID_nguoi_dung);
            const userName = user ? (user.ho_ten || user.username || item.ID_nguoi_dung) : item.ID_nguoi_dung;
            alert(`Chi ti·∫øt phi·∫øu m∆∞·ª£n:\n\nM√£: ${item.ID_muon_tra}\nNg∆∞·ªùi m∆∞·ª£n: ${userName}\nS√°ch: ${item.ten_sach}\nNg√†y m∆∞·ª£n: ${item.ngay_muon}\nNg√†y tr·∫£ d·ª± ki·∫øn: ${item.ngay_tra_du_kien}\nTr·∫°ng th√°i: ${item.trang_thai || 'ƒêang m∆∞·ª£n'}`);
        }

        // Approve return
        async function approveReturn(id) {
            if (!id) return showToast('ID kh√¥ng h·ª£p l·ªá');
            if (!confirm('X√°c nh·∫≠n duy·ªát tr·∫£ s√°ch n√†y?')) return;

            try {
                const res = await fetch('/api/approve-return.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ID_muon_tra: id })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('ƒê√£ duy·ªát tr·∫£ s√°ch th√†nh c√¥ng');
                    loadBorrowReturnData(currentBorrowFilter);
                    loadStatistics(); // Refresh statistics
                } else {
                    showToast(data.message || 'Kh√¥ng th·ªÉ duy·ªát tr·∫£ s√°ch');
                }
            } catch (error) {
                console.error('L·ªói duy·ªát tr·∫£:', error);
                showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß');
            }
        }

        // Filter buttons
        document.getElementById('filterAllBorrow')?.addEventListener('click', () => {
            document.querySelectorAll('#borrow-return-section button[id^="filter"]').forEach(btn => {
                btn.className = 'ghost-btn';
            });
            document.getElementById('filterAllBorrow').className = 'primary-btn';
            loadBorrowReturnData('all');
        });

        document.getElementById('filterPending')?.addEventListener('click', () => {
            document.querySelectorAll('#borrow-return-section button[id^="filter"]').forEach(btn => {
                btn.className = 'ghost-btn';
            });
            document.getElementById('filterPending').className = 'primary-btn';
            loadBorrowReturnData('pending');
        });

        document.getElementById('filterReturned')?.addEventListener('click', () => {
            document.querySelectorAll('#borrow-return-section button[id^="filter"]').forEach(btn => {
                btn.className = 'ghost-btn';
            });
            document.getElementById('filterReturned').className = 'primary-btn';
            loadBorrowReturnData('returned');
        });

        // Load statistics
        async function loadStatistics() {
            try {
                // Load all required data
                const [booksRes, borrowRes, usersRes] = await Promise.all([
                    fetch('/api/sach.php'),
                    fetch('/api/muon_tra.php'),
                    fetch('/api/nguoidung.php?loai=2')
                ]);

                const booksData = await booksRes.json();
                const borrowData = await borrowRes.json();
                const usersDataRes = await usersRes.json();

                const totalBooks = (booksData.success && Array.isArray(booksData.data)) ? booksData.data.length : 0;
                const borrowRecords = (borrowData.success && Array.isArray(borrowData.data)) ? borrowData.data : [];
                const totalReaders = (usersDataRes.success && Array.isArray(usersDataRes.data)) ? usersDataRes.data.length : 0;

                // Calculate active borrows (not returned)
                const activeBorrows = borrowRecords.filter(item => item.trang_thai !== 'ƒê√£ tr·∫£').length;

                // Update stats in the UI
                const statsCards = document.querySelectorAll('#stats-section > div:first-of-type > div');
                if (statsCards.length >= 3) {
                    statsCards[0].querySelector('div:first-child').textContent = totalReaders;
                    statsCards[1].querySelector('div:first-child').textContent = totalBooks;
                    statsCards[2].querySelector('div:first-child').textContent = borrowRecords.length;
                }
            } catch (error) {
                console.error('L·ªói t·∫£i th·ªëng k√™:', error);
            }
        }
    </script>
</body>
</html>
